---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: infisical
  namespace: flux-system
spec:
  interval: 30m
  chart:
    spec:
      chart: infisical-standalone
      version: 1.7.2
      sourceRef:
        kind: HelmRepository
        name: infisical-repo
        namespace: flux-system
  targetNamespace: infisical
  install:
    createNamespace: true
    remediation:
      retries: 5
  upgrade:
    # cleanupOnFail: true
    remediation:
      retries: 3
  values:
    infisical:
      enabled: true
      name: infisical

      # -- Automatically migrates new database schema when deploying
      autoDatabaseSchemaMigration: true

      databaseSchemaMigrationJob:
        image:
          repository: ghcr.io/groundnuty/k8s-wait-for
          tag: no-root-v2.0
          pullPolicy: IfNotPresent

      serviceAccount:
        create: true
        annotations: {}
        name: null

      fullnameOverride: ""
      podAnnotations: {}
      deploymentAnnotations: {}
      replicaCount: 1

      image:
        repository: infisical/infisical
        tag: "v0.132.4-postgres"
        pullPolicy: IfNotPresent
        imagePullSecrets: []

      affinity: {}
      # -- Kubernetes Secret reference containing Infisical root credentials
      kubeSecretRef: infisical-auth

      service:
        annotations: {}
        type: ClusterIP

      # resources:
      #   limits:
      #     memory: 1024Mi
      #   requests:
      #     cpu: 350m

    ingress:
      enabled: true
      annotations:
        cert-manager.io/cluster-issuer: letsencrypt-tls
        nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
      ingressClassName: nging
      nginx:
        enabled: false
      hostName: &infisical-host infisical.${INTERNAL_ADDRESS}
      tls:
        - secretName: infisical-tls
          hosts:
            - *infisical-host
