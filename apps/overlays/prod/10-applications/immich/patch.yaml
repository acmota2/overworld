---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: immich
  namespace: flux-system
spec:
  interval: 5m0s
  values:
    controllers:
      main:
        containers:
          main:
            env:
              REDIS_HOSTNAME: dragonfly.db.svc.cluster.local
              REDIS_PORT: "6379"
              DB_HOSTNAME: psql-cluster-rw.db.svc.cluster.local
              DB_PORT: "5432"
              DB_USERNAME: immich
              DB_PASSWORD:
                valueFrom:
                  secretKeyRef:
                    name: immich-db-creds
                    key: password
              IMMICH_MACHINE_LEARNING_URL: http://immich-machine-learning:3003
    immich:
      persistence:
        library:
          existingClaim: immich-library-pvc
      configuration:
        trash:
          enabled: true
          days: 30
    server:
      main:
        ingress:
          enabled: false
    machine-learning:
      persistence:
        cache:
          enabled: true
          size: 10Gi
          type: persistentVolumeClaim
          accessMode: ReadWriteMany
          storageClass: longhorn
